var t,e,n,s,r,a=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)},o=(t,e,n)=>(a(t,e,"read from private field"),n?n.call(t):e.get(t)),i=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)},c=(t,e,n,s)=>(a(t,e,"write to private field"),s?s.call(t,n):e.set(t,n),n);import{S as h,i as l,s as p,H as u,j as d,m as f,o as $,v as g,r as m,w as b,D as w,e as v,c as k,a as y,d as M,b as C,f as E,_ as x,E as P,F as j,k as G,n as S,G as T,z as A,I,J as O,K as W}from"../chunks/vendor-4a259baa.js";import{u as L,c as N,l as z,p as D,s as J,a as V,b as _,d as q}from"../chunks/store-d13b1474.js";function F(t){let e,n,s;return n=new w({}),{c(){e=v("div"),d(n.$$.fragment),this.h()},l(t){e=k(t,"DIV",{slot:!0});var s=y(e);f(n.$$.fragment,s),s.forEach(M),this.h()},h(){C(e,"slot","skip-to-content")},m(t,r){E(t,e,r),$(n,e,null),s=!0},i(t){s||(g(n.$$.fragment,t),s=!0)},o(t){m(n.$$.fragment,t),s=!1},d(t){t&&M(e),b(n)}}}function H(t){let e,n;return e=new u({props:{company:"⬡ ⬢ ⬡ ",platformName:"canvas",$$slots:{"skip-to-content":[F]},$$scope:{ctx:t}}}),{c(){d(e.$$.fragment)},l(t){f(e.$$.fragment,t)},m(t,s){$(e,t,s),n=!0},p(t,[n]){const s={};1&n&&(s.$$scope={dirty:n,ctx:t}),e.$set(s)},i(t){n||(g(e.$$.fragment,t),n=!0)},o(t){m(e.$$.fragment,t),n=!1},d(t){b(e,t)}}}class K extends h{constructor(t){super(),l(this,t,null,H,p,{})}}const U={"canvas-view":[["/primary","canvas-view"]]};class B extends class{constructor(t,e){this.api=t,this.channel=e,this.errorCount=0,console.log(this.channel),this.channel.setOnChannelError(this.onChannelError.bind(this)),this.channel.setOnChannelOpen(this.onChannelOpen.bind(this))}delete(){this.channel.delete()}restart(){this.handleEvent({data:{connection:"reconnecting"}}),this.start()}onChannelOpen(t){this.errorCount=0,this.handleEvent({data:{connection:"connected"}})}onChannelError(t){if(console.error("event source error: ",t),this.errorCount++,this.errorCount>=5)return console.error("bailing out, too many retries"),void this.handleEvent({data:{connection:"disconnected"}});this.handleEvent({data:{connection:"reconnecting"}}),setTimeout((()=>{this.restart()}),750*Math.pow(2,this.errorCount-1))}subscribe(t,e){return this.api.subscribe(t,"PUT",this.api.ship,e,this.handleEvent.bind(this),(n=>{console.log(n),this.subscribe(t,e)}),(()=>{this.subscribe(t,e)}))}unsubscribe(t){this.api.unsubscribe(t)}start(){}handleEvent(t){}}{constructor(){super(...arguments),this.openSubscriptions={"canvas-view":[]}}start(){this.subscribe("/primary","canvas-view")}restart(){super.restart(),x.mapValues(this.openSubscriptions,((t,e)=>{t.length>0&&(this.stopApp(e),this.startApp(e))}))}startApp(t){this.openSubscriptions[t].length>0?console.log(`${t} already started`):this.openSubscriptions[t]=U[t].map((([t,e])=>this.subscribe(t,e)))}stopApp(t){this.openSubscriptions[t].map((t=>this.unsubscribe(t))),this.openSubscriptions[t]=[]}handleEvent(t){console.log(t);const e=t.data;null!==e&&("clear"in e&&e.clear||("connection"in e?L(e.connection):"init-frontend"in e?N(e["init-frontend"].canvas):"load"in e?z(e.load):"paint"in e?D(e.paint):"gcp-token"in e&&J(e["gcp-token"])))}}class Q{constructor(t,e){this.ship=t,this.channel=e,this.bindPaths=[]}unsubscribe(t){this.channel.unsubscribe(t)}subscribe(t,e,n=this.ship,s,r,a,o){return this.bindPaths=x.uniq([...this.bindPaths,t]),this.channel.subscribe(this.ship,s,t,(t=>{a(t)}),(e=>{r({data:e,from:{ship:n,path:t}})}),(t=>{o(t)}))}action(t,e,n,s=window.ship){return new Promise(((r,a)=>{this.channel.poke(s,t,e,n,(t=>{r(t)}),(t=>{a(t)}))}))}scry(t,e){return fetch(`/~/scry/${t}${e}.json`).then((t=>t.json()))}async spider(t,e,n,s){console.log(`/spider/${t}/${n}/${e}.json`);return(await fetch(`/spider/${t}/${n}/${e}.json`,{method:"POST",body:JSON.stringify(s)})).json()}}class R extends Q{async create(t,e,n,s,r,a){console.log(t,e,n,s,r,a);const o={mesh:{canvas:null,metadata:{name:t,location:e,saved:!1,private:s,template:n,width:r,height:a}}};return this.sendPoke({create:o})}async send(t,e,n){console.log("paint",t,e);const s={"canvas-name":e,location:t,strokes:n};return this.sendPoke({paint:s})}async sendPoke(t){return this.action("canvas-view","json",t)}}class X extends Q{async isConfigured(){return this.spider("noun","json","gcp-is-configured",{})}async getToken(){return this.spider("noun","gcp-token","gcp-get-token",{})}}t=new WeakMap,e=new WeakMap,n=new WeakMap,s=new WeakMap,r=new WeakMap;const Y=new class{constructor(){i(this,t,null),i(this,e,!1),i(this,n,null),i(this,s,0),i(this,r,!1)}configure(e){c(this,t,e)}start(){o(this,e)?console.warn("GcpManager already running"):o(this,t)?(c(this,e,!0),this.refreshLoop()):console.error("GcpManager must have api set")}stop(){if(!o(this,e))return console.warn("GcpManager already stopped"),void console.assert(null===o(this,n));c(this,e,!1),null!==o(this,n)&&(clearTimeout(o(this,n)),c(this,n,null))}restart(){o(this,e)&&this.stop(),this.start()}refreshLoop(){var e,n;o(this,r)?null==(n=o(this,t))||n.getToken().then((()=>{const t=P(V).gcpToken;if(!t)throw new Error("thread succeeded, but returned no token?");{c(this,s,0);const e=this.refreshInterval(t.expiresIn);console.log("GcpManager got token; refreshing after",e),this.refreshAfter(e)}})).catch((()=>{c(this,s,1+ +o(this,s)),console.warn("GcpManager token refresh failed; retrying with backoff"),this.refreshAfter(this.backoffInterval())})):null==(e=o(this,t))||e.isConfigured().then((t=>{if(void 0===t)throw new Error("can't check whether GCP is configured?");c(this,r,t),o(this,r)?this.refreshLoop():(console.log("GcpManager: GCP storage not configured; stopping."),this.stop())})).catch((t=>{console.error("GcpManager failure; stopping.",t),this.stop()}))}refreshAfter(t){o(this,e)&&(null===o(this,n)?c(this,n,setTimeout((()=>{c(this,n,null),this.refreshLoop()}),t)):console.warn("GcpManager already has a timeout set"))}refreshInterval(t){return Math.max(18e5,t-6e4)}backoffInterval(){return 5e3*Math.floor(Math.random()*Math.min(60,o(this,s)))}};function Z(t){let e;const n=t[0].default,s=O(n,t,t[1],null);return{c(){s&&s.c()},l(t){s&&s.l(t)},m(t,n){s&&s.m(t,n),e=!0},p(t,r){s&&s.p&&(!e||2&r)&&W(s,n,t,t[1],r,null,null)},i(t){e||(g(s,t),e=!0)},o(t){m(s,t),e=!1},d(t){s&&s.d(t)}}}function tt(t){let e,n;return e=new I({props:{$$slots:{default:[Z]},$$scope:{ctx:t}}}),{c(){d(e.$$.fragment)},l(t){f(e.$$.fragment,t)},m(t,s){$(e,t,s),n=!0},p(t,n){const s={};2&n&&(s.$$scope={dirty:n,ctx:t}),e.$set(s)},i(t){n||(g(e.$$.fragment,t),n=!0)},o(t){m(e.$$.fragment,t),n=!1},d(t){b(e,t)}}}function et(t){let e,n,s,r,a;return n=new K({}),r=new j({props:{$$slots:{default:[tt]},$$scope:{ctx:t}}}),{c(){e=v("main"),d(n.$$.fragment),s=G(),d(r.$$.fragment)},l(t){e=k(t,"MAIN",{});var a=y(e);f(n.$$.fragment,a),s=S(a),f(r.$$.fragment,a),a.forEach(M)},m(t,o){E(t,e,o),$(n,e,null),T(e,s),$(r,e,null),a=!0},p(t,[e]){const n={};2&e&&(n.$$scope={dirty:e,ctx:t}),r.$set(n)},i(t){a||(g(n.$$.fragment,t),g(r.$$.fragment,t),a=!0)},o(t){m(n.$$.fragment,t),m(r.$$.fragment,t),a=!1},d(t){t&&M(e),b(n),b(r)}}}function nt(t,e,n){let{$$slots:s={},$$scope:r}=e;var a=this&&this.__awaiter||function(t,e,n,s){return new(n||(n=Promise))((function(r,a){function o(t){try{c(s.next(t))}catch(e){a(e)}}function i(t){try{c(s.throw(t))}catch(e){a(e)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,i)}c((s=s.apply(t,e||[])).next())}))};return A((()=>a(void 0,void 0,void 0,(function*(){const t=new window.channel,e=new R(window.ship,t),n=new X(window.ship,t),s=new B(e,t);_(e),q(s),Y.configure(n),Y.start(),s.start()})))),t.$$set=t=>{"$$scope"in t&&n(1,r=t.$$scope)},[s,r]}Object.freeze(Y);export default class extends h{constructor(t){super(),l(this,t,nt,et,p,{})}}

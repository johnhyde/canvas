var t,n,e,s,r,a=(t,n,e)=>{if(!n.has(t))throw TypeError("Cannot "+e)},o=(t,n,e)=>(a(t,n,"read from private field"),e?e.call(t):n.get(t)),i=(t,n,e)=>{if(n.has(t))throw TypeError("Cannot add the same private member more than once");n instanceof WeakSet?n.add(t):n.set(t,e)},c=(t,n,e,s)=>(a(t,n,"write to private field"),s?s.call(t,e):n.set(t,e),e);import{S as h,i as l,s as p,H as u,j as d,m as f,o as $,v as g,r as m,w as v,D as w,e as b,c as k,a as y,d as M,b as C,f as E,_ as x,E as j,F as P,k as G,n as S,G as T,z as A,I,J as O,K as W}from"../chunks/vendor-aa83d449.js";import{u as L,c as N,l as z,p as D,s as J,a as V,b as _,d as q}from"../chunks/store-70363575.js";function F(t){let n,e,s;return e=new w({}),{c(){n=b("div"),d(e.$$.fragment),this.h()},l(t){n=k(t,"DIV",{slot:!0});var s=y(n);f(e.$$.fragment,s),s.forEach(M),this.h()},h(){C(n,"slot","skip-to-content")},m(t,r){E(t,n,r),$(e,n,null),s=!0},i(t){s||(g(e.$$.fragment,t),s=!0)},o(t){m(e.$$.fragment,t),s=!1},d(t){t&&M(n),v(e)}}}function H(t){let n,e;return n=new u({props:{company:"⬡ ⬢ ⬡ ",platformName:"canvas",$$slots:{"skip-to-content":[F]},$$scope:{ctx:t}}}),{c(){d(n.$$.fragment)},l(t){f(n.$$.fragment,t)},m(t,s){$(n,t,s),e=!0},p(t,[e]){const s={};1&e&&(s.$$scope={dirty:e,ctx:t}),n.$set(s)},i(t){e||(g(n.$$.fragment,t),e=!0)},o(t){m(n.$$.fragment,t),e=!1},d(t){v(n,t)}}}class K extends h{constructor(t){super(),l(this,t,null,H,p,{})}}const U={"canvas-view":[["/primary","canvas-view"]]};class B extends class{constructor(t,n){this.api=t,this.channel=n,this.errorCount=0,console.log(this.channel),this.channel.setOnChannelError(this.onChannelError.bind(this)),this.channel.setOnChannelOpen(this.onChannelOpen.bind(this))}delete(){this.channel.delete()}restart(){this.handleEvent({data:{connection:"reconnecting"}}),this.start()}onChannelOpen(t){this.errorCount=0,this.handleEvent({data:{connection:"connected"}})}onChannelError(t){if(console.error("event source error: ",t),this.errorCount++,this.errorCount>=5)return console.error("bailing out, too many retries"),void this.handleEvent({data:{connection:"disconnected"}});this.handleEvent({data:{connection:"reconnecting"}}),setTimeout((()=>{this.restart()}),750*Math.pow(2,this.errorCount-1))}subscribe(t,n){return this.api.subscribe(t,"PUT",this.api.ship,n,this.handleEvent.bind(this),(e=>{console.log(e),this.subscribe(t,n)}),(()=>{this.subscribe(t,n)}))}unsubscribe(t){this.api.unsubscribe(t)}start(){}handleEvent(t){}}{constructor(){super(...arguments),this.openSubscriptions={"canvas-view":[]}}start(){this.subscribe("/primary","canvas-view")}restart(){super.restart(),x.mapValues(this.openSubscriptions,((t,n)=>{t.length>0&&(this.stopApp(n),this.startApp(n))}))}startApp(t){this.openSubscriptions[t].length>0?console.log(`${t} already started`):this.openSubscriptions[t]=U[t].map((([t,n])=>this.subscribe(t,n)))}stopApp(t){this.openSubscriptions[t].map((t=>this.unsubscribe(t))),this.openSubscriptions[t]=[]}handleEvent(t){console.log(t);const n=t.data;null!==n&&("clear"in n&&n.clear||("connection"in n?L(n.connection):"init-frontend"in n?N(n["init-frontend"].canvas):"load"in n?z(n.load):"paint"in n?D(n.paint):"gcp-token"in n&&J(n["gcp-token"])))}}class Q{constructor(t,n){this.ship=t,this.channel=n,this.bindPaths=[]}unsubscribe(t){this.channel.unsubscribe(t)}subscribe(t,n,e=this.ship,s,r,a,o){return this.bindPaths=x.uniq([...this.bindPaths,t]),this.channel.subscribe(this.ship,s,t,(t=>{a(t)}),(n=>{r({data:n,from:{ship:e,path:t}})}),(t=>{o(t)}))}action(t,n,e,s=window.ship){return new Promise(((r,a)=>{this.channel.poke(s,t,n,e,(t=>{r(t)}),(t=>{a(t)}))}))}scry(t,n){return fetch(`/~/scry/${t}${n}.json`).then((t=>t.json()))}async spider(t,n,e,s){console.log(`/spider/${t}/${e}/${n}.json`);return(await fetch(`/spider/${t}/${e}/${n}.json`,{method:"POST",body:JSON.stringify(s)})).json()}}class R extends Q{async create(t,n,e,s,r,a){console.log(t,n,e,s,r,a);const o={mesh:{canvas:null,metadata:{name:t,location:n,saved:!1,private:s,template:e,width:r,height:a}}};return this.sendPoke({create:o})}async send(t,n,e){console.log("paint",t,n);const s={"canvas-name":n,location:t,strokes:e};return this.sendPoke({paint:s})}async join(t,n){console.log("join",t,n);const e={"canvas-name":n,ship:t};return this.sendPoke({join:e})}async sendPoke(t){return this.action("canvas-view","json",t)}}class X extends Q{async isConfigured(){return this.spider("noun","json","gcp-is-configured",{})}async getToken(){return this.spider("noun","gcp-token","gcp-get-token",{})}}t=new WeakMap,n=new WeakMap,e=new WeakMap,s=new WeakMap,r=new WeakMap;const Y=new class{constructor(){i(this,t,null),i(this,n,!1),i(this,e,null),i(this,s,0),i(this,r,!1)}configure(n){c(this,t,n)}start(){o(this,n)?console.warn("GcpManager already running"):o(this,t)?(c(this,n,!0),this.refreshLoop()):console.error("GcpManager must have api set")}stop(){if(!o(this,n))return console.warn("GcpManager already stopped"),void console.assert(null===o(this,e));c(this,n,!1),null!==o(this,e)&&(clearTimeout(o(this,e)),c(this,e,null))}restart(){o(this,n)&&this.stop(),this.start()}refreshLoop(){var n,e;o(this,r)?null==(e=o(this,t))||e.getToken().then((()=>{const t=j(V).gcpToken;if(!t)throw new Error("thread succeeded, but returned no token?");{c(this,s,0);const n=this.refreshInterval(t.expiresIn);console.log("GcpManager got token; refreshing after",n),this.refreshAfter(n)}})).catch((()=>{c(this,s,1+ +o(this,s)),console.warn("GcpManager token refresh failed; retrying with backoff"),this.refreshAfter(this.backoffInterval())})):null==(n=o(this,t))||n.isConfigured().then((t=>{if(void 0===t)throw new Error("can't check whether GCP is configured?");c(this,r,t),o(this,r)?this.refreshLoop():(console.log("GcpManager: GCP storage not configured; stopping."),this.stop())})).catch((t=>{console.error("GcpManager failure; stopping.",t),this.stop()}))}refreshAfter(t){o(this,n)&&(null===o(this,e)?c(this,e,setTimeout((()=>{c(this,e,null),this.refreshLoop()}),t)):console.warn("GcpManager already has a timeout set"))}refreshInterval(t){return Math.max(18e5,t-6e4)}backoffInterval(){return 5e3*Math.floor(Math.random()*Math.min(60,o(this,s)))}};function Z(t){let n;const e=t[0].default,s=O(e,t,t[1],null);return{c(){s&&s.c()},l(t){s&&s.l(t)},m(t,e){s&&s.m(t,e),n=!0},p(t,r){s&&s.p&&(!n||2&r)&&W(s,e,t,t[1],r,null,null)},i(t){n||(g(s,t),n=!0)},o(t){m(s,t),n=!1},d(t){s&&s.d(t)}}}function tt(t){let n,e;return n=new I({props:{$$slots:{default:[Z]},$$scope:{ctx:t}}}),{c(){d(n.$$.fragment)},l(t){f(n.$$.fragment,t)},m(t,s){$(n,t,s),e=!0},p(t,e){const s={};2&e&&(s.$$scope={dirty:e,ctx:t}),n.$set(s)},i(t){e||(g(n.$$.fragment,t),e=!0)},o(t){m(n.$$.fragment,t),e=!1},d(t){v(n,t)}}}function nt(t){let n,e,s,r,a;return e=new K({}),r=new P({props:{$$slots:{default:[tt]},$$scope:{ctx:t}}}),{c(){n=b("main"),d(e.$$.fragment),s=G(),d(r.$$.fragment)},l(t){n=k(t,"MAIN",{});var a=y(n);f(e.$$.fragment,a),s=S(a),f(r.$$.fragment,a),a.forEach(M)},m(t,o){E(t,n,o),$(e,n,null),T(n,s),$(r,n,null),a=!0},p(t,[n]){const e={};2&n&&(e.$$scope={dirty:n,ctx:t}),r.$set(e)},i(t){a||(g(e.$$.fragment,t),g(r.$$.fragment,t),a=!0)},o(t){m(e.$$.fragment,t),m(r.$$.fragment,t),a=!1},d(t){t&&M(n),v(e),v(r)}}}function et(t,n,e){let{$$slots:s={},$$scope:r}=n;var a=this&&this.__awaiter||function(t,n,e,s){return new(e||(e=Promise))((function(r,a){function o(t){try{c(s.next(t))}catch(n){a(n)}}function i(t){try{c(s.throw(t))}catch(n){a(n)}}function c(t){var n;t.done?r(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(o,i)}c((s=s.apply(t,n||[])).next())}))};return A((()=>a(void 0,void 0,void 0,(function*(){const t=new window.channel,n=new R(window.ship,t),e=new X(window.ship,t),s=new B(n,t);_(n),q(s),Y.configure(e),Y.start(),s.start()})))),t.$$set=t=>{"$$scope"in t&&e(1,r=t.$$scope)},[s,r]}Object.freeze(Y);export default class extends h{constructor(t){super(),l(this,t,et,nt,p,{})}}
